# Template for ROS2 development


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## Introduction

This is a template repository that inherits from the template repository
[template_uv_nbdev](https://github.com/Ramon-PR/template_uv_nbdev3). The
goal is to develop ROS2 packages by combining the capabilities of `uv`
to manage and install python packages and the notebook development and
documentation capabilities offered by `nbdev`. Although ROS2 is
installed in the system, `uv` and `nbdev` can be used to integrate ROS2
development, with other python packages, and to document the development
process in notebooks.

This template offers a set of shell scripts to automate the creation of
uv and nbdev projects, creation of ROS2 workspace and packages, and some
examples of use.

### Setup uv & nbdev project

run the shell script `prepare_project.bash` to initiate the project
structure where you can start developing and installing your local
python packages with `uv` and document the process with `nbdev`
notebooks.

``` sh
$ bash prepare_project.bash
```

### Create a ROS2 workspace

ROS2 in installed in the system, therefore we will create the ROS2
workspace inside the `uv` and `nbdev` project structure, but we will not
use `uv` to manage the ROS2 workspace. The script `generate_ros2_ws.zsh`
automates the creation of a ROS2 workspace, by default named
`new_ros2_ws`, although you can give as an argument the name you want
for the workspace.

``` sh
$ zsh generate_ros2_ws.zsh [workspace_name]
```

### Create ROS2 workspace and package

To automate the creation of ROS2 python packages, the script
`mk_ros2pkg_opencv.zsh` gives you an example of how to create a ROS2
package. This example includes the OpenCV dependencies to create a
camera node to publish images and another node to subscribe to the
images and display them. The script has two inputs, the name of the ROS2
workspace and the name of the ROS2 package. It first checks if the
workspace exists (by default `new_ros2_ws`), and if not, it creates a
ROS2 workspace using `generate_ros2_ws.zsh`. At last, it creates the
ROS2 package with the given name (or `pkg_ros2_opencv` by default).

``` sh
$ zsh mk_ros2pkg_opencv.zsh [workspace_name] [package_name]
```

### Compilation

Once the ROS2 workspace and package structure has been created, the
python files containing the python code for the ROS2 nodes have to be
putted in the folder `[package_name]/[package_name]/` where there should
already be an `__init__.py` file. The nodes written in python can be
tested directly using the python of the system and the packages
installed in the system after sourcing the ROS2 installation path.
Example:

``` sh
$ deactivate # To make sure you are not in an environment with its local python 
$ source /opt/ros/jazzy/setup.zsh # jazzy or any other ROS2 distro you have installed
$ which python3 # It should point to the system python, /usr/bin/python3
$ python3 camera_subscriber.py # python 
```

This approach is useful for testing and development, but for a more
robust solution, the ROS2 package should be compiled using `colcon`.
Compiling with `colcon` among other benefits, includes: + The use of
`ros2 run [package_name] [node_name]` to run the nodes. + The use of
launch files, to launch multiple nodes at the same time. + Remap and
parameterization capabilities (without touching the python code, we can
change the topic names, or the parameters of the nodes when launching
them). + Once installed and sourced the workspace, we can run the nodes
from any place in the system. + It handle nodes both in python and C++
in the same workspace. + You can use other ROS2 tools like `rosdep` to
check and install dependencies.

To be able to compile ros2 packages with python files, there are two
files to check and edit if necessary: - package.xml: to check if the
dependencies are correct (The script `mk_ros2pkg_opencv.zsh` already
includes the dependencies for the OpenCV example) - setup.py: where we
have to write the entrypoints for the python nodes. The entrypoints are
the way to tell ROS2 where the nodes are located and how to run them.
For example, to run:

``` sh
$ ros2 run pkg_ros2_opencv camera_subscriber
```

we need to write in the `setup.py` file of the package `pkg_ros2_opencv`
the entrypoint for the node `camera_subscriber`:

``` python
    entry_points={
        'console_scripts': [
            'camera_subscriber = pkg_ros2_opencv.camera_subscriber:main',
            'camera_publisher = pkg_ros2_opencv.camera_publisher:main',
        ],
    },
```

To be clear, the run command would be

``` sh
$ ros2 run [package_name] [name_entry_point_node]
```

and the entry point in the `setup.py` file would be

``` python
    entry_points={
        'console_scripts': [
            '[name_entry_point_node] = [package_name].[python_filename]:main',
        ],
    },
```

And in the python file we should define the class of the node, define
the `main` function that creates an instance of the node class and spins
it, and finally call the `main` function in the
`if __name__ == '__main__':` block.

To simplify the compilation process, name your python files with the
same name you want for the entry point of that node. Save those files in
the folder `[package_name]/[package_name]/` and then run the following
commands and use the shell script `compile_pkg.sh`.

``` sh
$ ./compile_pkg.sh [workspace_name] [package_name]
```

This script will copy a python script `auto_setup.py` next to `setup.py`
that will automatically read all the python files in your package folder
and write the entry points in the `setup.py` file. After that, it will
compile the package with `colcon build`.

# Summary

The pipeline to create and compile a ROS2 package would be:  
1. Create the ROS2 workspace with `generate_ros2_ws.zsh [workspace_name]`
2. Create the ROS2 package with
`mk_ros2pkg_opencv.zsh [workspace_name] [package_name]` (tune it to use
the dependencies you need).
3. Write the python code for the nodes in
the folder `[package_name]/[package_name]/` and name the python files
with the same name you want for the entry point of that node.
4. Compile the package with 
`compile_pkg.sh [workspace_name] [package_name]` that
will automatically write the entry points in the `setup.py` file and
compile the package with `colcon build`.
5. Test your nodes by sourcing
the workspace and running the nodes with
`ros2 run [package_name] [name_entry_point_node]` or with launch files.
